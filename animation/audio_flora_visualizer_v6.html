<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Audio Visualizer v6 â€“ åŒè‘‰/èŠ±ãƒ¡ã‚¤ãƒ³ãƒ»æ„Ÿåº¦ãƒˆã‚°ãƒ«ãƒ»é‡èª¿æ•´ãƒ»ãƒ¢ãƒã‚¤ãƒ«UI</title>
  <!-- p5.js & sound addon -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/addons/p5.sound.min.js"></script>
  <style>
    :root { color-scheme: dark; --glass: rgba(255,255,255,0.08); --line: rgba(255,255,255,0.16); }
    html, body { margin:0; padding:0; background:#0b0b0f; color:#eee; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans JP", sans-serif; }
    /* Top/desktop panel */
    #ui {
      position: fixed; left: 16px; top: 16px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
      background: var(--glass); border: 1px solid var(--line);
      padding: 8px 10px; border-radius: 12px; backdrop-filter: blur(6px); z-index:3;
    }
    #ui button, #ui label, #ui select, #ui summary {
      appearance: none; border: 1px solid rgba(255,255,255,0.18); background: rgba(255,255,255,0.08);
      color: #eee; padding: 6px 10px; border-radius: 10px; cursor: pointer; font-size: 12px;
    }
    #ui select { padding: 6px 8px; }
    #ui button:hover, #ui label:hover { background: rgba(255,255,255,0.16); }
    #file { display: none; }
    #legend {
      position: fixed; right: 16px; top: 16px; font-size: 12px; line-height: 1.45;
      color: #cfd7ff; opacity: .9; background: rgba(16,16,24,.35); border: 1px solid rgba(255,255,255,.08);
      padding: 8px 10px; border-radius: 10px; z-index:2; max-width: 42ch;
    }
    #fab { /* mobile gear button */
      position: fixed; right: 14px; bottom: 14px; z-index: 4;
      border: 1px solid rgba(255,255,255,0.25); background: rgba(255,255,255,0.15);
      color:#fff; padding: 12px; border-radius: 999px; cursor: pointer; font-size: 16px; display:none;
    }
    #panel { /* mobile drawer */
      position: fixed; left: 0; right: 0; bottom: -70vh; height: 60vh; z-index: 4;
      background: rgba(20,20,28,0.95); backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.14);
      transition: bottom 0.25s ease; padding: 10px 12px; border-radius: 14px 14px 0 0;
    }
    #panel.open { bottom: 0; }
    #panel .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    #panel h4 { margin: 6px 0 6px; font-size: 13px; opacity: .9; }
    #panel select, #panel button, #panel label { font-size: 14px; padding: 10px; border-radius: 12px; }
    #panel .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .pill { display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border:1px solid rgba(255,255,255,0.18); border-radius: 999px; background: rgba(255,255,255,0.08); font-size:12px; cursor:pointer; }
    .active { outline: 1px solid rgba(255,255,255,0.45); }
    a { color: #9ec5ff; }
    /* Responsive: mobile-first control */
    @media (max-width: 680px) {
      #ui { display:none; }
      #legend { display:none; }
      #fab { display:block; }
    }
  </style>
</head>
<body>
  <!-- Desktop/Tablet controls -->
  <div id="ui">
    <label for="file">éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«</label><input id="file" type="file" accept="audio/*"/>
    <button id="mic">ãƒã‚¤ã‚¯</button>
    <button id="play">å†ç”Ÿ</button>
    <button id="pause">ä¸€æ™‚åœæ­¢</button>
    <button id="record">éŒ²ç”»é–‹å§‹</button>
    <details id="adv"><summary>âš™ï¸ èª¿æ•´</summary>
      <div class="row">
        <label>éŸ³é‡æ„Ÿåº¦</label>
        <select id="sense">
          <option value="low">éˆæ„Ÿ</option>
          <option value="normal" selected>ãµã¤ã†</option>
          <option value="high">æ•æ„Ÿ</option>
        </select>
        <label>ç”»é¢ON</label><button id="wake">OFF</button>
      </div>
      <div class="row">
        <label>åŒè‘‰/èŠ± é‡</label>
        <select id="plantAmt">
          <option value="0.6">å°‘ãªã‚</option>
          <option value="1" selected>ãµã¤ã†</option>
          <option value="1.6">å¤šã‚</option>
        </select>
        <label>ğŸ¦‹ é‡</label>
        <select id="bflyAmt">
          <option value="0.3" selected>æ§ãˆã‚</option>
          <option value="1">ãµã¤ã†</option>
          <option value="1.6">å¤šã‚</option>
        </select>
      </div>
      <div class="row">
        <label>â˜„ï¸ æµæ˜Ÿ é‡</label>
        <select id="meteorAmt">
          <option value="0.6" selected>å°‘ãªã‚</option>
          <option value="1">ãµã¤ã†</option>
          <option value="1.6">å¤šã‚</option>
        </select>
        <label>âœ¨ æ˜Ÿ é‡</label>
        <select id="dustAmt">
          <option value="0.6">å°‘ãªã‚</option>
          <option value="1" selected>ãµã¤ã†</option>
          <option value="1.6">å¤šã‚</option>
        </select>
      </div>
    </details>
    <span id="status" style="margin-left:8px; font-size:12px; opacity:.85;">æº–å‚™ä¸­</span>
  </div>

  <!-- Mobile: floating button + drawer -->
  <button id="fab">âš™ï¸</button>
  <div id="panel">
    <div class="row" style="justify-content:space-between">
      <div class="pill" id="pickFileM"><span>ğŸ“„</span><span>éŸ³å£°</span></div>
      <div class="pill" id="micM"><span>ğŸ¤</span><span>ãƒã‚¤ã‚¯</span></div>
      <div class="pill" id="playM"><span>â–¶</span><span>å†ç”Ÿ</span></div>
      <div class="pill" id="pauseM"><span>â¸</span><span>åœæ­¢</span></div>
      <div class="pill" id="recM"><span>âº</span><span>éŒ²ç”»</span></div>
    </div>
    <h4>éŸ³é‡æ„Ÿåº¦</h4>
    <div class="row">
      <select id="senseM">
        <option value="low">éˆæ„Ÿ</option>
        <option value="normal" selected>ãµã¤ã†</option>
        <option value="high">æ•æ„Ÿ</option>
      </select>
      <label>ç”»é¢ON</label><button id="wakeM">OFF</button>
    </div>
    <h4>é‡ã®èª¿æ•´</h4>
    <div class="grid">
      <div><label>åŒè‘‰/èŠ±</label>
        <select id="plantAmtM">
          <option value="0.6">å°‘</option><option value="1" selected>æ™®</option><option value="1.6">å¤š</option>
        </select>
      </div>
      <div><label>ğŸ¦‹</label>
        <select id="bflyAmtM">
          <option value="0.3" selected>æ§</option><option value="1">æ™®</option><option value="1.6">å¤š</option>
        </select>
      </div>
      <div><label>â˜„ï¸</label>
        <select id="meteorAmtM">
          <option value="0.6" selected>å°‘</option><option value="1">æ™®</option><option value="1.6">å¤š</option>
        </select>
      </div>
      <div><label>âœ¨</label>
        <select id="dustAmtM">
          <option value="0.6">å°‘</option><option value="1" selected>æ™®</option><option value="1.6">å¤š</option>
        </select>
      </div>
    </div>
  </div>

  <div id="legend">
    <div>â€” ç™½ã„ç·š: åŸºæº–</div>
    <div>ğŸŒ± åŒè‘‰ãƒ»ğŸŒ¼ èŠ±: 200â€“2000Hzï¼ˆ<b>åŒä¸€åœ°ç‚¹ã¯æœ€å¤§3æœ¬</b>ï¼‰</div>
    <div>ğŸ¦‹ ã¡ã‚‡ã†ã¡ã‚‡: <b>2000Hzä»¥ä¸Š</b>ï¼ˆå°ã•ãå°‘ãªã‚ï¼‰</div>
    <div>âœ¨ æ˜Ÿã‚­ãƒ©ã‚­ãƒ©: é¢¨æ™¯ãƒã‚¤ã‚ºï¼ˆã‚¹ãƒšã‚¯ãƒˆãƒ«å¹³å¦ã•ï¼‰</div>
    <div>â˜„ï¸ é•·ã„æµæ˜Ÿ: ä½/è¶…é«˜å¸¯åŸŸ or å¤§ããªéŸ³é‡<br>â€»<b>ãƒ‰ãƒ³ï¼</b>ã¯å„ªå…ˆã—ã¦<b>èŠ±ãƒãƒ¼ã‚¹ãƒˆ</b></div>
    <div>ç„¡éŸ³/çµ‚äº† â†’ ç™½ç·šã®ã¿</div>
  </div>

  <script>
    // ======= Audio + Analysis =======
    let fft, amp, mic, sound, usingMic = false, fileLoaded = false;
    let lastActiveMillis = 0;   // éŸ³ãŒé³´ã£ã¦ã„ã‚‹æœ€çµ‚æ™‚åˆ»
    let silenceFade = 0;        // ç„¡éŸ³æ™‚ã®ãƒ•ã‚§ãƒ¼ãƒ‰ 0..1
    // dynamic sensitivity
    const sense = { mode: 'normal', ampScale:1.0, gate:0.008, peak:0.12, donDelta:0.08 };
    function applySense(mode){
      sense.mode = mode;
      if (mode==='low'){ sense.ampScale=0.85; sense.gate=0.012; sense.peak=0.16; sense.donDelta=0.11; }
      else if (mode==='high'){ sense.ampScale=1.2; sense.gate=0.005; sense.peak=0.09; sense.donDelta=0.06; }
      else { sense.ampScale=1.0; sense.gate=0.008; sense.peak=0.12; sense.donDelta=0.08; }
      if (plantPeak) plantPeak.threshold = sense.peak;
    }

    // ======= Visual State =======
    const plants = [];      // sprout/flower
    const butterflies = []; // ğŸ¦‹
    const dustStars = [];   // background twinkles
    const meteors = [];     // â˜„ï¸
    let baselineY;
    let prevLevel = 0;
    let donCooldown = 0; // frames to suppress meteors after DON

    // åœ°ç‚¹ã”ã¨ã®ã€ŒåŒæ™‚æœ€å¤§3æœ¬ã€åˆ¶ç´„ç”¨ã®ãƒ“ãƒ³ï¼ˆæ¨ªæ–¹å‘ï¼‰
    let NUM_BINS = 36; let BIN_W = 0;

    const E = { level:0, plantBand:0, bflyBand:0, bass:0, ultra:0, entropy:0 };
    let plantPeak; // peak detector for plant band

    // Multipliers (é‡)
    const amount = { plant:1, bfly:0.33, meteor:0.6, dust:1 };

    // Wake Lock
    let wakeLock = null;
    async function toggleWake(btn){
      try{
        if (!wakeLock) { wakeLock = await navigator.wakeLock.request('screen'); btn.textContent='ON'; }
        else { await wakeLock.release(); wakeLock=null; btn.textContent='OFF'; }
      }catch(e){ console.warn('wake lock:', e); btn.textContent='NG'; }
    }

    // ======= Recording =======
    let mediaRecorder = null, recordedChunks = [], destNode = null;

    function setup() {
      createCanvas(window.innerWidth, window.innerHeight);
      pixelDensity(window.devicePixelRatio || 1);
      baselineY = height * 0.85;

      fft = new p5.FFT(0.85, 1024);
      amp = new p5.Amplitude();
      plantPeak = new p5.PeakDetect(200, 2000, sense.peak, 14);

      textFont('Noto Sans JP, system-ui, sans-serif');
      noStroke();

      applySense('normal');
      calcBins();
      bindUI();
    }

    function calcBins(){ NUM_BINS = max(24, floor(width / 48)); BIN_W = width / NUM_BINS; }
    function xToBin(x){ return constrain(floor(x / BIN_W), 0, NUM_BINS-1); }
    function countPlantsInBin(bi){
      let c = 0; for (let p of plants){ if (!p.dead && xToBin(p.x)===bi) c++; } return c;
    }

    function bindUI() {
      const $ = (id)=>document.getElementById(id);
      const status = $('status');

      // desktop controls
      $('file').addEventListener('change', async (e) => {
        await userStartAudio(); stopAllAudio();
        const f = e.target.files[0]; if (!f) return;
        const url = URL.createObjectURL(f);
        sound = loadSound(url, () => {
          fileLoaded = true; usingMic = false;
          amp.setInput(sound); fft.setInput(sound);
          status.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†'; sound.onended(()=>{ lastActiveMillis = millis()-5000; });
        }, (err)=>{ status.textContent='èª­ã¿è¾¼ã¿å¤±æ•—'; console.error(err); });
      });
      $('mic').addEventListener('click', async () => {
        await userStartAudio(); stopAllAudio();
        mic = new p5.AudioIn(); mic.start(()=>{
          usingMic=true; fileLoaded=false; amp.setInput(mic); fft.setInput(mic);
          status.textContent='ãƒã‚¤ã‚¯å…¥åŠ›ä¸­';
        }, (err)=>{ status.textContent='ãƒã‚¤ã‚¯è¨±å¯ã‚¨ãƒ©ãƒ¼'; console.error(err); });
      });
      $('play').addEventListener('click', async ()=>{ await userStartAudio(); if (sound&&fileLoaded){ if(!sound.isPlaying()) sound.play(); status.textContent='å†ç”Ÿä¸­'; } });
      $('pause').addEventListener('click', ()=>{ if (sound&&sound.isPlaying()){ sound.pause(); status.textContent='ä¸€æ™‚åœæ­¢'; } });
      $('record').addEventListener('click', async ()=>{ if(!mediaRecorder){ await startRecording(); $('record').textContent='éŒ²ç”»åœæ­¢'; $('record').classList.add('active'); } else { await stopRecording(); $('record').textContent='éŒ²ç”»é–‹å§‹'; $('record').classList.remove('active'); } });
      $('sense').addEventListener('change', (e)=>applySense(e.target.value));
      $('plantAmt').addEventListener('change', (e)=>amount.plant=parseFloat(e.target.value));
      $('bflyAmt').addEventListener('change', (e)=>amount.bfly=parseFloat(e.target.value));
      $('meteorAmt').addEventListener('change', (e)=>amount.meteor=parseFloat(e.target.value));
      $('dustAmt').addEventListener('change', (e)=>amount.dust=parseFloat(e.target.value));
      $('wake').addEventListener('click', ()=>toggleWake($('wake')));

      // mobile drawer + fab
      const panel = $('panel'); const fab = $('fab');
      fab.addEventListener('click', ()=>panel.classList.toggle('open'));
      $('pickFileM').addEventListener('click', ()=>$('file').click());
      $('micM').addEventListener('click', ()=>$('mic').click());
      $('playM').addEventListener('click', ()=>$('play').click());
      $('pauseM').addEventListener('click', ()=>$('pause').click());
      $('recM').addEventListener('click', ()=>$('record').click());
      $('senseM').addEventListener('change', (e)=>{ $('sense').value=e.target.value; $('sense').dispatchEvent(new Event('change')); });
      $('plantAmtM').addEventListener('change', (e)=>{ $('plantAmt').value=e.target.value; $('plantAmt').dispatchEvent(new Event('change')); });
      $('bflyAmtM').addEventListener('change', (e)=>{ $('bflyAmt').value=e.target.value; $('bflyAmt').dispatchEvent(new Event('change')); });
      $('meteorAmtM').addEventListener('change', (e)=>{ $('meteorAmt').value=e.target.value; $('meteorAmt').dispatchEvent(new Event('change')); });
      $('dustAmtM').addEventListener('change', (e)=>{ $('dustAmt').value=e.target.value; $('dustAmt').dispatchEvent(new Event('change')); });
      $('wakeM').addEventListener('click', ()=>toggleWake($('wakeM')));
    }

    function windowResized() { resizeCanvas(window.innerWidth, window.innerHeight); baselineY = height * 0.85; calcBins(); }
    function stopAllAudio() { if (sound){ try{sound.stop();}catch(e){} } if (mic){ try{mic.stop();}catch(e){} } }

    function draw() {
      background(11, 11, 15, 255);

      // è§£æ
      const spectrum = fft.analyze();
      let level = amp.getLevel() * sense.ampScale; level = constrain(level, 0, 1);
      E.level = lerp(E.level, level, 0.2); // smoothed level
      plantPeak.update(fft);

      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åˆ¤å®š + ç„¡éŸ³ãƒ•ã‚§ãƒ¼ãƒ‰
      const active = level > sense.gate || (sound && sound.isPlaying());
      if (active) lastActiveMillis = millis();
      const silentFor = millis() - lastActiveMillis;
      if (silentFor > 900) { silenceFade = min(1, silenceFade + 0.03); } else { silenceFade = max(0, silenceFade - 0.05); }

      // ç™½ã„åŸºæº–ç·š
      stroke(255); strokeWeight(3); line(0, baselineY, width, baselineY); noStroke();

      // ====== ã‚¨ãƒãƒ«ã‚® ======
      const plantBand = fft.getEnergy(200, 2000);
      const bflyBand  = fft.getEnergy(2000, 8000);
      const bass   = fft.getEnergy(20, 120);
      const ultra  = fft.getEnergy(8000, 16000);

      // ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼ï¼ˆãƒã‚¤ã‚ºåº¦ï¼‰
      let sum = 0; for (let i=0;i<spectrum.length;i++) sum += spectrum[i] + 1e-6;
      let entropy = 0; for (let i=0;i<spectrum.length;i++){ const p = (spectrum[i]+1e-6)/sum; entropy += -p*Math.log(p); }
      entropy = entropy / Math.log(spectrum.length);

      // Smooth
      E.plantBand = lerp(E.plantBand, plantBand, 0.25);
      E.bflyBand  = lerp(E.bflyBand,  bflyBand,  0.25);
      E.bass      = lerp(E.bass,      bass,      0.25);
      E.ultra     = lerp(E.ultra,     ultra,     0.25);
      E.entropy   = lerp(E.entropy,   entropy,   0.25);

      // ====== èƒŒæ™¯ãƒã‚¤ã‚º â†’ ã‚­ãƒ©ã‚­ãƒ©æ˜Ÿ ======
      const dustCount = floor(map(E.entropy, 0.6, 1.0, 0, 10*amount.dust, true));
      for (let i=0;i<dustCount;i++) dustStars.push(new DustStar(random(width), random(height*0.05, height*0.65), E.entropy));

      // ====== DON! æ¤œå‡ºï¼šLevelã®ç«‹ã¡ä¸ŠãŒã‚Šã§åˆ¤å®š ======
      const delta = max(0, level - prevLevel);
      prevLevel = level;
      if (delta > sense.donDelta && level > sense.gate*2) {
        // èŠ±å„ªå…ˆï¼šãƒãƒ¼ã‚¹ãƒˆã‚’ç”Ÿæˆã—ã€çŸ­æ™‚é–“ã¯æµæ˜Ÿã‚’æŠ‘åˆ¶
        donCooldown = 22; // ~0.36s @60fps
        const clusters = floor(random(1, 3 + amount.plant)); // 1ã€œ(2+)
        for (let c=0;c<clusters;c++){
          const center = random(width);
          const n = floor(random(3, 6) * amount.plant);
          for (let i=0;i<n;i++){
            const x = constrain(center + random(-24, 24), 0, width);
            spawnPlantSmart(E.plantBand, x);
          }
        }
      }
      if (donCooldown>0) donCooldown--;

      // ====== é€šå¸¸ã®åŒè‘‰ãƒ»èŠ± ======
      if (E.plantBand > 70 && random() < 0.35 * amount.plant) spawnPlantSmart(E.plantBand);
      if (plantPeak.isDetected) {
        const burst = floor(random(3, 7) * amount.plant);
        for (let i=0;i<burst;i++) spawnPlantSmart(E.plantBand);
      }

      // ====== ğŸ¦‹ï¼ˆå°ã•ããƒ»å°‘ãªã‚ãƒ»2000Hz+ï¼‰ ======
      if ((E.bflyBand > 130 && random() < 0.012 * amount.bfly) || random() < 0.003 * amount.bfly) {
        butterflies.push(new Butterfly(random(width), random(height*0.35, height*0.75), 0.45)); // even smaller
      }

      // ====== æµæ˜Ÿï¼ˆæŸ”è»Ÿãƒˆãƒªã‚¬ã€ãŸã ã—DONå¾Œã¯æŠ‘åˆ¶ï¼‰ ======
      const meteorTrig = (E.level > 0.2) || (E.bass > 130) || (E.ultra > 130);
      if (donCooldown===0 && meteorTrig && meteors.length < 6 && random() < 0.22 * amount.meteor) {
        const dir = random([-1, 1]);
        const startX = (dir>0 ? random(width*0.05, width*0.45) : random(width*0.55, width*0.95));
        const startY = random(height*0.05, height*0.5);
        const vx = dir * random(7.5, 10.5);
        const vy = random(6.0, 9.0);
        meteors.push(new Meteor(startX, startY, vx, vy, floor(random(28, 50))));
      }

      // ====== æ›´æ–°ãƒ»æç”» ======
      for (let i = dustStars.length-1; i>=0; i--) { dustStars[i].update(); dustStars[i].draw(silenceFade); if (dustStars[i].dead) dustStars.splice(i,1); }
      for (let i = meteors.length-1; i>=0; i--) { meteors[i].update(); meteors[i].draw(silenceFade); if (meteors[i].dead) meteors.splice(i,1); }
      for (let i = plants.length-1; i>=0; i--) { plants[i].update(); plants[i].draw(silenceFade); if (plants[i].dead) plants.splice(i,1); }
      for (let i = butterflies.length-1; i>=0; i--) { butterflies[i].update(); butterflies[i].draw(silenceFade); if (butterflies[i].dead) butterflies.splice(i,1); }

      // ç„¡éŸ³ãƒ•ã‚§ãƒ¼ã‚º
      if (silenceFade > 0.95) { /* ç™½ç·šã®ã¿ */ }
    }

    // ====== Plant spawn helpers ======
    function spawnPlantSmart(energy, fixedX=null){
      const tries = 12;
      for (let k=0;k<tries;k++){
        const x = (fixedX==null) ? random(width) : fixedX + random(-6,6);
        const bi = xToBin(x);
        if (countPlantsInBin(bi) < 3){
          const type = (random() < 0.55 ? 'sprout' : 'flower');
          plants.push(new Plant(constrain(x,0,width), type, energy));
          break;
        }
      }
    }

    // ======= Easing =======
    function easeOutCubic(t){ return 1 - pow(1 - t, 3); }
    function easeOutBack(t){ const c1 = 1.70158, c3 = c1 + 1; return 1 + c3*pow(t-1,3) + c1*pow(t-1,2); }

    // ======= Classes =======
    class Plant {
      constructor(x, type, energy) {
        this.x = x; this.type = type; this.life = 0; this.dead = false;
        const baseH = (type==='sprout') ? random(10, 18) : random(22, 44);
        const sizeK = map(energy, 70, 255, 0.9, 1.4, true);
        this.hTarget = baseH * sizeK;
        this.growFrames = floor(random(48, 90));
        this.bloomStart = this.growFrames * 0.55;
        this.age = 0; this.maxAge = this.growFrames + floor(random(90, 160));
        this.leafW = random(10, 16) * sizeK * (type==='sprout'?1.2:1.0);
        this.leafH = random(5.5, 8.0) * sizeK * (type==='sprout'?1.2:1.0);
        this.flowerR = random(7, 12) * sizeK;
        this.swing = random(0.012, 0.022); this.seed = random(1000);
      }
      update(){ this.age++; if (this.age > this.maxAge) this.dead = true; }
      draw(silence){
        const y0 = baselineY;
        const t = constrain(this.age / this.growFrames, 0, 1);
        const grow = easeOutCubic(t);
        const sway = sin(frameCount * this.swing + this.seed) * 5 * (1 - silence);
        const stemH = this.hTarget * grow * (1 - silence*0.95);
        const topX = this.x + sway; const topY = y0 - stemH;
        stroke(255); strokeWeight(1.8); line(this.x, y0, topX, topY); noStroke();
        if (this.type === 'flower') {
          const bt = t < 0.001 ? 0 : constrain((this.age - this.bloomStart)/ (this.growFrames - this.bloomStart + 1), 0, 1);
          const open = easeOutBack(bt);
          const r = this.flowerR * (0.4 + 0.6 * open) * (1 - silence*0.9);
          push(); translate(topX, topY); fill(255);
          for (let i=0;i<6;i++){ const a = i * PI/3 + this.seed*0.2; const pr = r*0.95; ellipse(cos(a)*pr, sin(a)*pr, pr*0.95, pr*0.95); }
          fill(255); circle(0,0, r*0.9); pop();
        } else {
          const lr = easeOutBack(t);
          const lw = this.leafW * lr * (1 - silence*0.9);
          const lh = this.leafH * lr * (1 - silence*0.9);
          push(); translate(topX, topY); fill(255);
          ellipse(-lw*0.7, 0, lw, lh); ellipse(+lw*0.7, 0, lw, lh); pop();
        }
      }
    }

    class Butterfly {
      constructor(x, y, scaleBase=0.45) {
        this.x = x; this.y = y; this.life = 0; this.maxLife = 300 + random(120); this.dead = false;
        this.vx = random(-0.5, 0.5); this.vy = random(-0.25, 0.25); this.phase = random(TWO_PI);
        this.s = scaleBase * random(0.9, 1.1);
      }
      update(){ this.life++; this.phase += 0.05; this.x += this.vx + sin(this.phase*1.6)*0.6; this.y += this.vy + cos(this.phase*1.1)*0.45; this.x = constrain(this.x, -20, width+20); this.y = constrain(this.y, height*0.25, baselineY-12); if (this.life>this.maxLife) this.dead=true; }
      draw(silence){
        const a = (1 - silence) * 220 * (1 - this.life/this.maxLife);
        push(); translate(this.x, this.y); scale(this.s); noStroke(); fill(255,a);
        const flap = 0.9 + sin(frameCount*0.45) * 0.30 * (1 - silence);
        push(); scale(flap,1); ellipse(-9,-2,16,12); ellipse(-8,5,14,10); ellipse(9,-2,16,12); ellipse(8,5,14,10); pop();
        rectMode(CENTER); rect(0,0,2.2,12,2);
        stroke(255,a); strokeWeight(1); noFill(); bezier(-1,-6,-5,-10,-7,-12,-8,-13); bezier(1,-6,5,-10,7,-12,8,-13);
        pop();
      }
    }

    class DustStar { constructor(x,y,noiseIndex){ this.x=x; this.y=y; this.life=0; this.maxLife=random(80,180); this.size=map(noiseIndex,0.6,1.0,0.9,2.8,true)*random(0.8,1.4); this.alpha=random(90,180); this.dead=false; }
      update(){ this.life++; if (this.life>this.maxLife) this.dead=true; }
      draw(silence){ const a=this.alpha*(1 - silence); fill(255,a); noStroke(); circle(this.x,this.y,this.size); } }

    class Meteor {
      constructor(x, y, vx, vy, life){ this.x=x; this.y=y; this.vx=vx; this.vy=vy; this.life=0; this.maxLife=life; this.dead=false; this.trail=[]; }
      update(){ this.life++; this.trail.push({x:this.x,y:this.y}); if (this.trail.length>20) this.trail.shift(); this.x+=this.vx; this.y+=this.vy; if (this.life>this.maxLife) this.dead=true; }
      draw(silence){ const alpha=230*(1 - silence); noFill(); for(let i=0;i<this.trail.length-1;i++){ const p1=this.trail[i],p2=this.trail[i+1]; const a=alpha*(i/this.trail.length); stroke(255,a); strokeWeight(map(i,0,this.trail.length-1,1,3.2)); line(p1.x,p1.y,p2.x,p2.y);} noStroke(); fill(255,alpha); ellipse(this.x,this.y,4.5,4.5); }
    }

    // ======= Recording (Canvas + Audio) =======
    async function startRecording() {
      if (mediaRecorder) return;
      const canvasStream = document.querySelector('canvas').captureStream(60);
      const ac = getAudioContext();
      if (!destNode) { destNode = ac.createMediaStreamDestination(); try { p5.soundOut.output.connect(destNode); } catch(e){ console.warn('audio connect failed', e); } }
      const combined = new MediaStream([ ...canvasStream.getVideoTracks(), ...destNode.stream.getAudioTracks() ]);
      mediaRecorder = new MediaRecorder(combined, { mimeType: 'video/webm;codecs=vp9,opus' });
      recordedChunks = [];
      mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
      mediaRecorder.onstop = e => { const blob = new Blob(recordedChunks, { type: 'video/webm' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'visualizer_v6.webm'; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1000); mediaRecorder = null; };
      mediaRecorder.start();
    }
    async function stopRecording() { if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop(); }
  </script>
</body>
</html>